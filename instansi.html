<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EDA Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #111827;
    color: #f3f4f6;
    margin: 0; padding: 20px;
  }
  h1 { margin: 0 0 16px; font-size: 22px; }
  .cards {
    display: flex; flex-wrap: wrap; gap: 16px;
  }
  .card {
    background: #1f2937;
    border-radius: 8px;
    padding: 16px;
    flex: 1; min-width: 180px;
  }
  .kpi { font-size: 28px; font-weight: bold; color: #60a5fa; }
  .note { font-size: 12px; margin-top: 6px; color: #9ca3af; }
  .legend { columns: 1; column-gap: 0; font-size: 14px; margin-top: 8px; }
  .chart-wrap { overflow-x: auto; }
</style>
</head>
<body>
  <h1>EDA Dashboard: INSTANSI vs NIP</h1>

  <!-- KPI CARDS -->
  <div class="cards">
    <section class="card">
      <div>Total Rows</div>
      <div id="kpiTotal" class="kpi">–</div>
    </section>
    <section class="card">
      <div>Unique NIP</div>
      <div id="kpiUnique" class="kpi">–</div>
    </section>
    <section class="card">
      <div>Duplicate NIP</div>
      <div id="kpiDup" class="kpi">–</div>
    </section>
  </div>

  <!-- HISTOGRAM -->
  <section class="card" style="margin-top:16px;">
    <h2 style="margin:0 0 8px; font-size:16px;">Histogram: Duplicate NIP per INSTANSI (codes)</h2>
    <div class="chart-wrap">
      <canvas id="dupChart" style="height:420px;"></canvas>
    </div>
    <div class="note">X-axis uses numeric codes. See LEGEND below.</div>
  </section>

  <!-- LEGEND -->
  <section class="card" style="margin-top:16px;">
    <h2 style="margin:0 0 8px; font-size:16px;">Legend (Code → INSTANSI)</h2>
    <div id="legend" class="legend muted">–</div>
  </section>

<script>
// ===== SETTINGS =====
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSYesleChlLlIDTlmOMkZHtJ5HDgOXAj8mswik1y36Ta9KnG3Nu9k-ZU8EhhlwIgg/pub?gid=1404169547&single=true&output=csv";

let chart;

// ===== MAIN PARSE =====
Papa.parse(CSV_URL, {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: (res)=>{
    try { runEDA(res.data); }
    catch(e){ console.error(e); alert("Error processing CSV. Columns required: INSTANSI, NIP"); }
  },
  error: (err)=>{ console.error(err); alert("Failed to fetch CSV"); }
});

function runEDA(rows){
  // Clean
  rows = rows.filter(r=> r.INSTANSI && r.NIP);

  // KPI calc
  const totalRows = rows.length;
  const nipAll = rows.map(r=> r.NIP);
  const nipSet = new Set(nipAll);
  const dupCount = totalRows - nipSet.size;

  // Group by INSTANSI
  const map = {};
  rows.forEach(r=>{
    const inst = r.INSTANSI.trim();
    if(!map[inst]) map[inst] = { total:0, dups:0 };
    map[inst].total++;
  });
  // Count duplicates
  const seen = new Set(), dups = new Set();
  nipAll.forEach(n=>{
    if(seen.has(n)) dups.add(n);
    else seen.add(n);
  });
  rows.forEach(r=>{
    if(dups.has(r.NIP)){
      map[r.INSTANSI.trim()].dups++;
    }
  });

  const summary = Object.entries(map).map(([inst,v])=>({
    INSTANSI: inst, TOTAL: v.total, DUPLICATE: v.dups
  }));
  summary.sort((a,b)=> b.DUPLICATE - a.DUPLICATE);

  // Assign numeric codes
  const legend = summary.map((r,i)=>({ code:i+1, inst:r.INSTANSI }));
  const labels = legend.map(x=> x.code);
  const dupCounts = summary.map(r=> r.DUPLICATE);

  // KPIs
  document.getElementById("kpiTotal").textContent = totalRows;
  document.getElementById("kpiUnique").textContent = nipSet.size;
  document.getElementById("kpiDup").textContent = dupCount;

  // Legend text
  document.getElementById("legend").innerHTML =
    legend.map(x=> `${x.code} → ${x.inst}`).join("<br>");

  // Chart
  const ctx = document.getElementById("dupChart");
  if(chart) chart.destroy();

  // widen canvas so bars not crushed
  ctx.style.minWidth = (labels.length * 28) + "px";

  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Duplicates',
        data: dupCounts,
        barThickness: 22,
        maxBarThickness: 26,
        categoryPercentage: 1.0,
        barPercentage: 1.0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { title: { display: true, text: 'LEGEND CODE' }, ticks: { autoSkip: false } },
        y: { title: { display: true, text: 'Jumlah Duplikat NIP' }, beginAtZero: true, ticks: { precision: 0 } }
      }
    }
  });
}
</script>
</body>
</html>

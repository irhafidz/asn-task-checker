<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>EDA Dashboard – INSTANSI (no NIP shown)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#111827; --panel:#1f2937; --text:#f3f4f6; --muted:#9ca3af; --accent:#60a5fa; --border:#374151;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; padding:20px; background:var(--bg); color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; }
  h1{ margin:0 0 12px; font-size:20px; }
  h2{ margin:0 0 8px; font-size:16px; }
  .cards{ display:flex; flex-wrap:wrap; gap:16px; }
  .card{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; }
  .kpi{ font-size:28px; font-weight:700; color:var(--accent); }
  .note{ font-size:12px; color:var(--muted); margin-top:6px; }
  .chart-wrap{ overflow-x:auto; }
  .legend{ columns:1; column-gap:0; font-size:14px; }
  table{ width:100%; border-collapse:collapse; }
  th, td{ padding:10px 12px; border-bottom:1px solid var(--border); font-size:13px; }
  th{ text-align:left; color:var(--muted); font-weight:600; }
  .mt{ margin-top:16px; }
</style>
</head>
<body>
  <h1>EDA Dashboard: INSTANSI vs NIP (no NIP displayed)</h1>

  <!-- KPI CARDS -->
  <div class="cards">
    <section class="card" style="min-width:200px;">
      <div>Total rows (all data)</div>
      <div id="kpiTotal" class="kpi">–</div>
    </section>
    <section class="card" style="min-width:200px;">
      <div>Unique NIP (global)</div>
      <div id="kpiUnique" class="kpi">–</div>
    </section>
    <section class="card" style="min-width:200px;">
      <div>Duplicate NIP (global, excess)</div>
      <div id="kpiDup" class="kpi">–</div>
    </section>
    <section class="card" style="min-width:200px;">
      <div>Duplicate groups (global)</div>
      <div id="kpiGroups" class="kpi">–</div>
    </section>
  </div>

  <!-- HISTOGRAM -->
  <section class="card mt">
    <h2>Histogram: Duplicate NIP per INSTANSI (codes)</h2>
    <div class="chart-wrap">
      <canvas id="dupChart" style="height:420px;"></canvas>
    </div>
    <div class="note">X-axis uses numeric codes. See LEGEND below.</div>
  </section>

  <!-- LEGEND -->
  <section class="card mt">
    <h2>Legend (Code → INSTANSI)</h2>
    <div id="legend" class="legend">–</div>
  </section>

  <!-- SUMMARY TABLE (RESTORED) -->
  <section class="card mt">
    <h2>Summary by INSTANSI</h2>
    <div class="note">Shows per-INSTANSI totals only (no NIP values shown anywhere).</div>
    <div style="overflow:auto;">
      <table id="summaryTbl">
        <thead>
          <tr>
            <th>#</th>
            <th>INSTANSI</th>
            <th>Total Rows</th>
            <th>Unique NIP</th>
            <th>Not Unique (Duplicates)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card mt">
  <h2>INSTANSI Not Found (from master 50)</h2>
  <div id="missingInstansi">–</div>
</section>

<script>
// ===== MASTER LIST (50 INSTANSI) =====
const MASTER_INSTANSI = [
  "BADAN KEPEGAWAIAN DAERAH",
  "BADAN KESATUAN BANGSA DAN POLITIK",
  "BADAN KOORDINASI WILAYAH BOJONEGORO",
  "BADAN KOORDINASI WILAYAH JEMBER",
  "BADAN KOORDINASI WILAYAH MADIUN",
  "BADAN KOORDINASI WILAYAH MALANG",
  "BADAN KOORDINASI WILAYAH PAMEKASAN",
  "BADAN PENANGGULANGAN BENCANA DAERAH",
  "BADAN PENDAPATAN DAERAH",
  "BADAN PENGELOLA KEUANGAN DAN ASET DAERAH",
  "BADAN PENGEMBANGAN SUMBER DAYA MANUSIA",
  "BADAN PENGHUBUNG DAERAH PROVINSI",
  "BADAN PERENCANAAN PEMBANGUNAN DAERAH",
  "BADAN RISET DAN INOVASI DAERAH",
  "DINAS ENERGI DAN SUMBER DAYA MINERAL",
  "DINAS KEBUDAYAAN DAN PARIWISATA",
  "DINAS KEHUTANAN",
  "DINAS KELAUTAN DAN PERIKANAN",
  "DINAS KEPEMUDAAN DAN OLAHRAGA",
  "DINAS KESEHATAN",
  "DINAS KOMUNIKASI DAN INFORMATIKA",
  "DINAS KOPERASI USAHA KECIL DAN MENENGAH",
  "DINAS LINGKUNGAN HIDUP",
  "DINAS PEKERJAAN UMUM BINA MARGA",
  "DINAS PEKERJAAN UMUM SUMBER DAYA AIR",
  "DINAS PEMBERDAYAAN MASYARAKAT DAN DESA",
  "DINAS PEMBERDAYAAN PEREMPUAN, PERLINDUNGAN ANAK DAN KEPENDUDUKAN",
  "DINAS PENANAMAN MODAL DAN PELAYANAN TERPADU SATU PINTU",
  "DINAS PENDIDIKAN INDUK",
  "DINAS PERHUBUNGAN",
  "DINAS PERINDUSTRIAN DAN PERDAGANGAN",
  "DINAS PERKEBUNAN",
  "DINAS PERPUSTAKAAN DAN KEARSIPAN",
  "DINAS PERTANIAN DAN KETAHANAN PANGAN",
  "DINAS PERUMAHAN RAKYAT, KAWASAN PERMUKIMAN DAN CIPTA KARYA",
  "DINAS PETERNAKAN",
  "DINAS SOSIAL",
  "DINAS TENAGA KERJA DAN TRANSMIGRASI",
  "INSPEKTORAT PROVINSI",
  "SATUAN POLISI PAMONG PRAJA",
  "BIRO ADMINISTRASI PEMBANGUNAN",
  "BIRO ADMINISTRASI PIMPINAN",
  "BIRO HUKUM",
  "BIRO KESEJAHTERAAN RAKYAT",
  "BIRO ORGANISASI",
  "BIRO PEMERINTAHAN DAN OTONOMI DAERAH",
  "BIRO PENGADAAN BARANG/JASA",
  "BIRO PEREKONOMIAN",
  "BIRO UMUM",
  "SEKRETARIAT DPRD"
];
</script>

  
<script>
// =================== SETTINGS ===================
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSLlpPcsZSdnlkrtAJUYQRWpjpOkfwV-2b-gToNu0No3PUxQ4-RcxHP7KlK5-cLGw/pub?gid=1934392472&single=true&output=csv";

let chart;

// =================== LOAD CSV ===================
Papa.parse(CSV_URL + "&cachebust=" + Date.now(), {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: (res) => {
    try { runEDA(res.data); }
    catch(e){ console.error(e); alert("Error processing CSV. Required columns: INSTANSI, NIP"); }
  },
  error: (err) => { console.error(err); alert("Failed to fetch CSV (is it published to the web?)"); }
});

// =================== EDA ===================
function runEDA(rows){
  // Clean & standardize
  const data = rows
    .map(r => ({
      INSTANSI: String(r.INSTANSI || "").trim().toUpperCase(),
      NIP:      String(r.NIP || "").trim()
    }))
    .filter(r => r.INSTANSI && r.NIP);

  // Global KPIs
  const totalRows = data.length;
  const globalNipCounts = new Map();
  for(const r of data){ globalNipCounts.set(r.NIP, (globalNipCounts.get(r.NIP) || 0) + 1); }
  const uniqueGlobal = [...globalNipCounts.keys()].length;
  const duplicateGroupsGlobal = [...globalNipCounts.values()].filter(n => n >= 2).length;
  const duplicateExcessGlobal = totalRows - uniqueGlobal; // “excess” duplicates

  document.getElementById("kpiTotal").textContent  = totalRows.toLocaleString("id-ID");
  document.getElementById("kpiUnique").textContent = uniqueGlobal.toLocaleString("id-ID");
  document.getElementById("kpiDup").textContent    = duplicateExcessGlobal.toLocaleString("id-ID");
  document.getElementById("kpiGroups").textContent = duplicateGroupsGlobal.toLocaleString("id-ID");

  // Per-INSTANSI summary
  // For each INSTANSI: total, unique NIP (within that INSTANSI), not_unique = total - unique
  const byInst = new Map();
  for(const r of data){
    if(!byInst.has(r.INSTANSI)){
      byInst.set(r.INSTANSI, { total:0, nipCounts:new Map() });
    }
    const g = byInst.get(r.INSTANSI);
    g.total += 1;
    g.nipCounts.set(r.NIP, (g.nipCounts.get(r.NIP) || 0) + 1);
  }

  const summary = [];
  for(const [inst, g] of byInst.entries()){
    const unique = [...g.nipCounts.keys()].length;
    const notUnique = g.total - unique; // “excess” rows to make NIP unique within INSTANSI
    summary.push({ INSTANSI: inst, TOTAL_ROWS: g.total, UNIQUE_NIP: unique, NOT_UNIQUE_NIP_COUNT: notUnique });
  }
  // Sort by duplicates desc, then total desc
  summary.sort((a,b) => (b.NOT_UNIQUE_NIP_COUNT - a.NOT_UNIQUE_NIP_COUNT) || (b.TOTAL_ROWS - a.TOTAL_ROWS));

  // Legend (numeric codes in same order as summary)
  const legend = summary.map((row, idx) => ({ code: idx+1, name: row.INSTANSI }));
  document.getElementById("legend").innerHTML =
    legend.map(x => `${x.code} = ${x.name}`).join("<br>");

  // ===== Histogram (use NOT_UNIQUE_NIP_COUNT per INSTANSI) =====
  const labels = legend.map(x => x.code);
  const dupCounts = summary.map(r => r.NOT_UNIQUE_NIP_COUNT);

  const ctx = document.getElementById("dupChart");
  if(chart) chart.destroy();
  // widen canvas so bars stay readable (≈ 28px per bar)
  ctx.style.minWidth = (labels.length * 28) + "px";

  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Duplicates (excess)",
        data: dupCounts,
        barThickness: 22,
        maxBarThickness: 26,
        categoryPercentage: 1.0,
        barPercentage: 1.0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { title: { display: true, text: "LEGEND CODE" }, ticks: { autoSkip: false } },
        y: { title: { display: true, text: "Jumlah Duplikat NIP (excess)" }, beginAtZero: true, ticks: { precision: 0 } }
      }
    }
  });

  // ===== Populate Summary Table (RESTORED) =====
  const tbody = document.querySelector("#summaryTbl tbody");
  tbody.innerHTML = "";
  summary.forEach((row, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML =
      `<td>${i+1}</td>
       <td>${row.INSTANSI}</td>
       <td>${row.TOTAL_ROWS}</td>
       <td>${row.UNIQUE_NIP}</td>
       <td>${row.NOT_UNIQUE_NIP_COUNT}</td>`;
    tbody.appendChild(tr);
  });
  // Build list of missing INSTANSI (those in MASTER not present in summary)
const presentInstansi = new Set(summary.map(r => r.INSTANSI));
const missingInstansi = MASTER_INSTANSI.filter(name => !presentInstansi.has(name));

// Render the missing list
document.getElementById("missingInstansi").innerHTML =
  missingInstansi.length
    ? missingInstansi.map(x => "• " + x).join("<br>")
    : "<em>All 50 INSTANSI are present.</em>";

}
</script>
</body>
</html>

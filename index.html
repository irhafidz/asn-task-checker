<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UOBK EDA (Live CSV)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <style>
    :root { --bg:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --thead:#f3f4f6; }
    *{box-sizing:border-box}
    body{margin:1rem;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg)}
    header{margin:0 0 1rem}
    h1{margin:.2rem 0;font-size:clamp(1.4rem,2.2vw,2rem)}
    .sub{color:var(--muted)}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:1rem}
    .kpis{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.75rem;margin:.75rem 0}
    .kpi{padding:.8rem;border:1px solid var(--border);border-radius:10px;background:#fafafa}
    .kpi .v{font-weight:700;font-size:1.15rem}
    .row{display:grid;gap:1rem}
    @media(min-width:1000px){.row{grid-template-columns:2fr 1fr}}
    .table-wrap{overflow:auto}
    table{border-collapse:collapse;width:100%;min-width:720px}
    th,td{border:1px solid var(--border);padding:.55rem .6rem;text-align:left;vertical-align:top}
    thead th{background:var(--thead)}
    .muted{color:var(--muted)}
    .found{color:#065f46}
    .notfound{color:#991b1b}
    .footer{margin-top:1rem;color:var(--muted)}
    canvas{max-height:520px}
    .err{margin-top:.8rem;padding:.7rem .9rem;border:1px solid #fecaca;background:#fef2f2;color:#7f1d1d;border-radius:10px;white-space:pre-wrap}
  </style>
</head>
<body>
  <header>
    <h1>Simple EDA: UOBK (Live CSV)</h1>
    <div class="sub">CSV: <code id="src"></code> • Dimuat: <span id="ts"></span></div>
  </header>

  <section class="card">
    <div class="kpis">
      <div class="kpi"><div class="t">TOTAL rows (Row_Count)</div><div id="kpiRows" class="v">-</div></div>
      <div class="kpi"><div class="t">Unique UOBK</div><div id="kpiUnique" class="v">-</div></div>
    </div>

    <div class="row">
      <div class="card" style="padding:1rem">
        <h3 style="margin-top:0">Bar Chart — Row Counts per UOBK</h3>
        <canvas id="barChart"></canvas>
      </div>
      <div class="card" style="padding:1rem">
        <h3 style="margin-top:0">Reference UOBK List Check</h3>
        <div class="muted" style="margin:.25rem 0 .5rem">Hanya memeriksa nama UOBK; tidak menampilkan NIP.</div>
        <div><strong>Found (dengan jumlah baris):</strong><ul id="refFound" class="found"></ul></div>
        <div style="margin-top:.6rem"><strong>Not Found:</strong><ul id="refNotFound" class="notfound"></ul></div>
      </div>
    </div>

    <div class="card" style="margin-top:1rem">
      <h3 style="margin-top:0">Tabel — Counts per UOBK</h3>
      <div class="table-wrap">
        <table>
          <thead><tr><th>UOBK</th><th>Row_Count</th><th>Percentage</th></tr></thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
      <div id="msg" class="footer"></div>
      <div id="err" class="err" style="display:none"></div>
    </div>
  </section>
<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5C1wkIPrNoBRwRaDohzVFT6wfeX0lfSl2BTCUpDcQwiuQtgkybGjcmzKl7LBu7g/pub?gid=1021451323&single=true&output=csv";
  const REFERENCE_UOBK = [
    "RS JIWA MENUR","RS MATA MASYARAKAT JAWA TIMUR","RS PARU JEMBER",
    "RS PARU MANGUHARJO PROVINSI JAWA TIMUR","RSUD DAHA HUSADA","RSUD DR. SAIFUL ANWAR",
    "RSUD DR. SOEDONO MADIUN","RSUD DR. SOETOMO","RSUD DUNGUS",
    "RSUD HAJI PROVINSI JAWA TIMUR","RSUD HUSADA PRIMA","RSUD KARSA HUSADA BATU",
    "RSUD MOHAMMAD NOER PAMEKASAN","RSUD SUMBERGLAGAH"
  ];

  const $ = (s)=>document.querySelector(s);
  const src = $("#src"), ts = $("#ts"), kpiRows = $("#kpiRows"), kpiUnique = $("#kpiUnique");
  const tblBody = $("#tblBody"), msg = $("#msg"), refFound = $("#refFound"), refNotFound = $("#refNotFound");
  const errBox = $("#err"), barCanvas = document.getElementById("barChart"); let barChart;

  // Small debug box to show headers if needed
  function ensureDebugBox() {
    if (!document.getElementById("debug")) {
      const d = document.createElement("div");
      d.id = "debug";
      d.style.cssText = "margin-top:.5rem;padding:.5rem .6rem;border:1px dashed #ddd;color:#6b7280;border-radius:8px;white-space:pre-wrap";
      d.innerHTML = "<strong>Debug:</strong> —";
      document.querySelector(".card:last-of-type").appendChild(d);
    }
  }
  function setDebug(text) {
    ensureDebugBox();
    document.getElementById("debug").innerHTML = "<strong>Debug:</strong>\n" + text;
  }

  function nowID() { return new Date().toLocaleString("id-ID",{hour12:false}); }
  function showErr(title, detail) {
    errBox.style.display = "block";
    errBox.textContent = title + (detail ? "\n\n" + detail : "");
  }

  async function loadCSVText(url) {
    const u = url + (url.includes("?") ? "&" : "?") + "v=" + Date.now(); // cache-bust
    const res = await fetch(u, { redirect: "follow" });
    let peek = "";
    try { peek = await res.clone().text(); } catch {}
    if (!res.ok) {
      throw new Error(`HTTP ${res.status} ${res.statusText}\nPratinjau respons (200 chars):\n` + (peek||"").slice(0,200));
    }
    return peek;
  }

  function parseCSVText(text) {
    const result = Papa.parse(text, { header:true, skipEmptyLines:true });
    return result.data.map(row => {
      const out = {};
      for (const k in row) {
        if (!Object.prototype.hasOwnProperty.call(row, k)) continue;
        const nk = (k || "").trim();
        const v = row[k];
        out[nk] = typeof v === "string" ? v.trim() : v;
      }
      return out;
    });
  }

  // Detect a "name" column for the UOBK entity
  function detectNameKey(rows) {
    const headers = Object.keys(rows[0] || {}).map(h => h.trim());
    // best guesses in order
    const candidates = [
      /^u\s*o\s*\/?\s*b\s*k$/i,           // UOBK, UO/BK
      /^uobk$/i,                          // UOBK
      /^nama\s*uobk$/i,                   // Nama UOBK
      /^instansi$/i,                      // INSTANSI
      /^perangkat\s*daerah$/i,            // Perangkat Daerah
      /^nama$/i,                          // Nama
      /uobk/i,                            // any header containing uobk
    ];
    for (const p of candidates) {
      const hit = headers.find(h => p.test(h));
      if (hit) return hit;
    }
    return null;
  }

  // Detect a category column that marks which rows are UOBK vs PD (optional)
  function detectCategoryKey(rows) {
    const headers = Object.keys(rows[0] || {}).map(h => h.trim());
    const candidates = [
      /^kategori$/i,
      /Perangkat\s*Daerah.*UOBK\??/i
    ];
    for (const p of candidates) {
      const hit = headers.find(h => p.test(h));
      if (hit) return hit;
    }
    // also accept any header that includes 'kategori' loosely
    const loose = headers.find(h => h.toLowerCase().includes("kategori"));
    return loose || null;
  }

  function filterUobkRows(rows, catKey) {
    if (!catKey) return rows; // no category column; use all rows
    return rows.filter(r => String(r[catKey] ?? "").trim().toLowerCase() === "uobk");
  }

  function groupCountsByKey(rows, nameKey) {
    const map = new Map();
    rows.forEach(r => {
      const u = String((r[nameKey] ?? "")).trim();
      if (!u) return;
      map.set(u, (map.get(u) || 0) + 1);
    });
    const total = Array.from(map.values()).reduce((a,b)=>a+b,0);
    const arr = Array.from(map.entries())
      .map(([UOBK, Row_Count]) => ({ UOBK, Row_Count, Percentage: Row_Count/total*100 }))
      .sort((a,b)=> b.Row_Count - a.Row_Count);
    return { rows: arr, total, unique: map.size };
  }

  function renderTable(arr){
    tblBody.innerHTML = arr.map(r=>`<tr>
      <td>${r.UOBK}</td><td>${r.Row_Count}</td><td>${r.Percentage.toFixed(1)}%</td>
    </tr>`).join("");
  }

  function renderChart(arr){
    const labels = arr.map(r=>r.UOBK);
    const counts = arr.map(r=>r.Row_Count);
    if (barChart) barChart.destroy();
    barChart = new Chart(barCanvas, {
      type: "bar",
      data: { labels, datasets: [{ label: "Row Count", data: counts }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display:false }, tooltip: { callbacks: { label: (ctx) => ` ${ctx.parsed.y} baris` } } },
        scales: { x: { ticks: { autoSkip:false, maxRotation:45 } }, y: { beginAtZero:true } }
      }
    });
  }

  function renderReferenceCheck(arr){
    const map = new Map(arr.map(r=>[r.UOBK, r.Row_Count]));
    const found = [], notFound = [];
    REFERENCE_UOBK.forEach(name=>{ map.has(name) ? found.push([name, map.get(name)]) : notFound.push(name); });
    refFound.innerHTML = found.map(([n,c])=>`<li>${n} → <strong>${c}</strong> rows</li>`).join("") || "<li><em>(none)</em></li>";
    refNotFound.innerHTML = notFound.map(n=>`<li>${n}</li>`).join("") || "<li><em>(none)</em></li>";
  }

  (async function init(){
    src.textContent = CSV_URL;
    msg.textContent = "Memuat…";
    try {
      const text = await loadCSVText(CSV_URL);
      const rows = parseCSVText(text);

      if (!rows.length) {
        showErr("CSV kosong atau tidak ter-parse.",
                "Cek apakah sheet yang dipublish berisi data.");
        msg.textContent = "Gagal memuat.";
        return;
      }

      // Show headers for visibility
      setDebug("Headers terdeteksi:\n- " + Object.keys(rows[0]).join("\n- "));

      const nameKey = detectNameKey(rows);
      if (!nameKey) {
        showErr("Kolom nama UOBK tidak ditemukan.",
                "Harap beri nama kolom seperti 'UOBK', 'Nama UOBK', 'INSTANSI', atau 'Perangkat Daerah'.");
        msg.textContent = "Gagal memuat.";
        return;
      }

      const catKey = detectCategoryKey(rows);       // optional
      const filtered = filterUobkRows(rows, catKey);
      const { rows: agg, total, unique } = groupCountsByKey(filtered, nameKey);

      kpiRows.textContent = total.toLocaleString("id-ID");
      kpiUnique.textContent = unique.toLocaleString("id-ID");
      renderTable(agg);
      renderChart(agg);
      renderReferenceCheck(agg);
      ts.textContent = nowID();
      msg.textContent = "Sukses. Data diperbarui.";
    } catch (e) {
      console.error(e);
      showErr("Gagal memuat. Pastikan URL adalah CSV publik dari Google Sheets.", String(e));
      msg.textContent = "Gagal memuat.";
    }
  })();
</script>

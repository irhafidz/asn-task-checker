<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UOBK EDA (Live CSV)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <style>
    :root { --bg:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --thead:#f3f4f6; }
    *{box-sizing:border-box}
    body{margin:1rem;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg)}
    header{margin:0 0 1rem}
    h1{margin:.2rem 0;font-size:clamp(1.4rem,2.2vw,2rem)}
    .sub{color:var(--muted)}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:1rem}
    .kpis{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.75rem;margin:.75rem 0}
    .kpi{padding:.8rem;border:1px solid var(--border);border-radius:10px;background:#fafafa}
    .kpi .v{font-weight:700;font-size:1.15rem}
    .row{display:grid;gap:1rem}
    @media(min-width:1000px){.row{grid-template-columns:2fr 1fr}}
    .table-wrap{overflow:auto}
    table{border-collapse:collapse;width:100%;min-width:720px}
    th,td{border:1px solid var(--border);padding:.55rem .6rem;text-align:left;vertical-align:top}
    thead th{background:var(--thead)}
    .muted{color:var(--muted)}
    .found{color:#065f46}
    .notfound{color:#991b1b}
    .footer{margin-top:1rem;color:var(--muted)}
    canvas{max-height:520px}
    .err{margin-top:.8rem;padding:.7rem .9rem;border:1px solid #fecaca;background:#fef2f2;color:#7f1d1d;border-radius:10px;white-space:pre-wrap}
  </style>
</head>
<body>
  <header>
    <h1>Simple EDA: UOBK (Live CSV)</h1>
    <div class="sub">Dimuat: <span id="ts"></span></div>
  </header>

  <section class="card">
    <div class="kpis">
      <div class="kpi"><div class="t">TOTAL rows (Row_Count)</div><div id="kpiRows" class="v">-</div></div>
      <div class="kpi"><div class="t">Unique UOBK</div><div id="kpiUnique" class="v">-</div></div>
    </div>

    <div class="row">
      <div class="card" style="padding:1rem">
        <h3 style="margin-top:0">Bar Chart — Row Counts per UOBK</h3>
        <canvas id="barChart"></canvas>
      </div>
      <div class="card" style="padding:1rem">
        <h3 style="margin-top:0">Bar Chart — NOT_Unique_NIP_Count per UOBK</h3>
        <canvas id="dupChart"></canvas>
      </div>
      <div class="card" style="padding:1rem">
        <h3 style="margin-top:0">Reference UOBK List Check</h3>
        <div class="muted" style="margin:.25rem 0 .5rem">Hanya memeriksa nama UOBK; tidak menampilkan NIP.</div>
        <div><strong>Found (dengan jumlah baris):</strong><ul id="refFound" class="found"></ul></div>
        <div style="margin-top:.6rem"><strong>Not Found:</strong><ul id="refNotFound" class="notfound"></ul></div>
      </div>
    </div>

    <div class="card" style="margin-top:1rem">
      <h3 style="margin-top:0">Tabel — Counts per UOBK</h3>
      <div class="table-wrap">
        <table>
        <thead>
          <tr>
            <th>UOBK</th>
            <th>Row_Count</th>
            <th>NIP_Count</th>
            <th>Unique_NIP_Count</th>
            <th>NOT_Unique_NIP_Count</th>
            <th>Percentage</th>
          </tr>
        </thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
      <div id="msg" class="footer"></div>
      <div id="err" class="err" style="display:none"></div>
    </div>
  </section>
<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRD2FkLSRAxEmCVAYF1PmkvnjPcOiwKw66uEO2wAEFO9sqoARiFkUjY1xetDqeqQA/pub?gid=1512741793&single=true&output=csv";
  const REFERENCE_UOBK = [
    "RS JIWA MENUR","RS MATA MASYARAKAT JAWA TIMUR","RS PARU JEMBER",
    "RS PARU MANGUHARJO PROVINSI JAWA TIMUR","RSUD DAHA HUSADA","RSUD DR. SAIFUL ANWAR",
    "RSUD DR. SOEDONO MADIUN","RSUD DR. SOETOMO","RSUD DUNGUS",
    "RSUD HAJI PROVINSI JAWA TIMUR","RSUD HUSADA PRIMA","RSUD KARSA HUSADA BATU",
    "RSUD MOHAMMAD NOER PAMEKASAN","RSUD SUMBERGLAGAH"
  ];

  const $ = (s)=>document.querySelector(s);
  const ts = $("#ts"), kpiRows = $("#kpiRows"), kpiUnique = $("#kpiUnique");
  const tblBody = $("#tblBody"), msg = $("#msg"), refFound = $("#refFound"), refNotFound = $("#refNotFound");
  const errBox = $("#err");
  const barCanvas = document.getElementById("barChart");
  const dupCanvas = document.getElementById("dupChart");
  let barChart, dupChart;

  function nowID() { return new Date().toLocaleString("id-ID",{hour12:false}); }
  function showErr(title, detail) {
    errBox.style.display = "block";
    errBox.textContent = title + (detail ? "\n\n" + detail : "");
  }

  async function loadCSVText(url) {
    const u = url + (url.includes("?") ? "&" : "?") + "v=" + Date.now();
    const res = await fetch(u, { redirect: "follow" });
    let peek = "";
    try { peek = await res.clone().text(); } catch {}
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}\n` + (peek||"").slice(0,200));
    return peek;
  }

  function parseCSVText(text) {
    const result = Papa.parse(text, { header:true, skipEmptyLines:true });
    return result.data.map(row => {
      const out = {};
      for (const k in row) {
        if (!Object.prototype.hasOwnProperty.call(row, k)) continue;
        const nk = (k || "").trim();
        const v = row[k];
        out[nk] = typeof v === "string" ? v.trim() : v;
      }
      return out;
    });
  }

  // --- Column detectors ---
  function detectUOBKKey(rows) {
    const headers = Object.keys(rows[0] || {}).map(h => h.trim());
    const patterns = [
      /^u\s*o\s*\/?\s*b\s*k$/i,
      /^uobk$/i,
      /perangkat.*uobk/i,
      /uobk/i
    ];
    for (const p of patterns) { const hit = headers.find(h => p.test(h)); if (hit) return hit; }
    return null;
  }
  function detectNIPKey(rows) {
    const headers = Object.keys(rows[0] || {}).map(h => h.trim());
    const nip = headers.find(h => /^nip$/i.test(h));
    if (nip) return nip;
    return headers.find(h => h.toLowerCase().includes("nip")) || null;
  }

  // --- Aggregations ---
  function baseCountsByUOBK(rows, uobkKey) {
    const map = new Map();
    rows.forEach(r => {
      const u = String((r[uobkKey] ?? "")).trim();
      if (!u) return;
      map.set(u, (map.get(u) || 0) + 1);
    });
    const total = Array.from(map.values()).reduce((a,b)=>a+b,0);
    const arr = Array.from(map.entries())
      .map(([UOBK, Row_Count]) => ({ UOBK, Row_Count }))
      .sort((a,b)=> b.Row_Count - a.Row_Count);
    return { arr, total };
  }

  function nipCountsByUOBK(rows, uobkKey, nipKey) {
    // Count all NIP (non-empty) and unique NIP per UOBK
    const countMap = new Map();   // total NIP per UOBK
    const setMap = new Map();     // unique NIP set per UOBK
    rows.forEach(r => {
      const u = String((r[uobkKey] ?? "")).trim();
      if (!u) return;
      const nipRaw = r[nipKey];
      const nip = (nipRaw == null ? "" : String(nipRaw)).trim();
      if (!nip) return; // ignore empty NIP cells
      countMap.set(u, (countMap.get(u) || 0) + 1);
      if (!setMap.has(u)) setMap.set(u, new Set());
      setMap.get(u).add(nip);
    });
    // Build rows
    const keys = new Set([...countMap.keys(), ...setMap.keys()]);
    const rowsOut = [...keys].map(u => {
      const NIP_Count = countMap.get(u) || 0;
      const Unique_NIP_Count = (setMap.get(u) ? setMap.get(u).size : 0);
      const NOT_Unique_NIP_Count = Math.max(0, NIP_Count - Unique_NIP_Count);
      return { UOBK: u, NIP_Count, Unique_NIP_Count, NOT_Unique_NIP_Count };
    });
    // Totals
    const totalNip = [...countMap.values()].reduce((a,b)=>a+b,0);
    const totalUnique = [...setMap.values()].reduce((a,s)=>a + s.size, 0);
    const totalNotUnique = Math.max(0, totalNip - totalUnique);
    const totals = { NIP_Count: totalNip, Unique_NIP_Count: totalUnique, NOT_Unique_NIP_Count: totalNotUnique };
    return { rowsOut, totals };
  }

  // --- Renderers ---
  function renderTable(merged){
    tblBody.innerHTML = merged.map(r=>`<tr>
      <td>${r.UOBK}</td>
      <td>${r.Row_Count}</td>
      <td>${r.NIP_Count ?? 0}</td>
      <td>${r.Unique_NIP_Count ?? 0}</td>
      <td>${r.NOT_Unique_NIP_Count ?? 0}</td>
      <td>${(r.Percentage ?? 0).toFixed(1)}%</td>
    </tr>`).join("");
  }

  function renderChartCounts(arr){
    const labels = arr.map(r=>r.UOBK);
    const counts = arr.map(r=>r.Row_Count);
    if (barChart) barChart.destroy();
    barChart = new Chart(barCanvas, {
      type: "bar",
      data: { labels, datasets: [{ label: "Row Count", data: counts }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display:false }, tooltip: { callbacks: { label: (ctx) => ` ${ctx.parsed.y} baris` } } },
        scales: { x: { ticks: { autoSkip:false, maxRotation:45 } }, y: { beginAtZero:true } }
      }
    });
  }

  function renderChartDuplicates(arr){
    const labels = arr.map(r=>r.UOBK);
    const dupCounts = arr.map(r=>r.NOT_Unique_NIP_Count ?? 0);
    if (dupChart) dupChart.destroy();
    dupChart = new Chart(dupCanvas, {
      type: "bar",
      data: { labels, datasets: [{ label: "NOT_Unique_NIP_Count", data: dupCounts }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display:false }, tooltip: { callbacks: { label: (ctx) => ` ${ctx.parsed.y} duplikat NIP` } } },
        scales: { x: { ticks: { autoSkip:false, maxRotation:45 } }, y: { beginAtZero:true } }
      }
    });
  }

  function renderReferenceCheck(arr){
    const map = new Map(arr.map(r=>[r.UOBK, r.Row_Count]));
    const found = [], notFound = [];
    REFERENCE_UOBK.forEach(name=>{ map.has(name) ? found.push([name, map.get(name)]) : notFound.push(name); });
    refFound.innerHTML = found.map(([n,c])=>`<li>${n} → <strong>${c}</strong> rows</li>`).join("") || "<li><em>(none)</em></li>";
    refNotFound.innerHTML = notFound.map(n=>`<li>${n}</li>`).join("") || "<li><em>(none)</em></li>";
  }

  (async function init(){
    msg.textContent = "Memuat…";
    try {
      const text = await loadCSVText(CSV_URL);
      const rows = parseCSVText(text);
      if (!rows.length) {
        showErr("CSV kosong atau tidak ter-parse.",
                "Cek apakah sheet yang dipublish berisi data.");
        msg.textContent = "Gagal memuat.";
        return;
      }

      // Detect columns
      const uobkKey = detectUOBKKey(rows);
      const nipKey  = detectNIPKey(rows);
      if (!uobkKey) {
        const headers = Object.keys(rows[0] || {});
        showErr("Kolom UOBK tidak ditemukan.",
                "Header terdeteksi: " + headers.join(", ") + "\nBeri nama kolom sebagai 'UOBK'.");
        msg.textContent = "Gagal memuat.";
        return;
      }
      // nipKey is optional; if missing, we’ll show zeros for NIP-based metrics
      const { arr: baseArr, total } = baseCountsByUOBK(rows, uobkKey);
      const percentageMap = new Map(baseArr.map(r=>[r.UOBK, (r.Row_Count/total*100)]));

      let nipAgg = { rowsOut: [], totals: { NIP_Count: 0, Unique_NIP_Count: 0, NOT_Unique_NIP_Count: 0 } };
      if (nipKey) nipAgg = nipCountsByUOBK(rows, uobkKey, nipKey);

      // Merge base + NIP metrics
      const nipMap = new Map(nipAgg.rowsOut.map(r=>[r.UOBK, r]));
      const merged = baseArr.map(r => {
        const nipRow = nipMap.get(r.UOBK) || {};
        return {
          UOBK: r.UOBK,
          Row_Count: r.Row_Count,
          NIP_Count: nipRow.NIP_Count ?? 0,
          Unique_NIP_Count: nipRow.Unique_NIP_Count ?? 0,
          NOT_Unique_NIP_Count: nipRow.NOT_Unique_NIP_Count ?? 0,
          Percentage: percentageMap.get(r.UOBK) ?? 0
        };
      });

      // KPI (reuse existing ones for Row_Count; if you want totals of NIP metrics, we could add more KPI tiles)
      kpiRows.textContent = total.toLocaleString("id-ID");
      kpiUnique.textContent = (new Set(merged.map(r=>r.UOBK))).size.toLocaleString("id-ID");

      // Render all
      renderTable(merged);
      renderChartCounts(merged);
      renderChartDuplicates(merged);
      renderReferenceCheck(merged);
      ts.textContent = nowID();
      msg.textContent = "Sukses. Data diperbarui.";
    } catch (e) {
      console.error(e);
      showErr("Gagal memuat. Pastikan URL adalah CSV publik dari Google Sheets.", String(e));
      msg.textContent = "Gagal memuat.";
    }
  })();
</script>


</body>
</html>
